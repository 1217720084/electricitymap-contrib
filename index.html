<!DOCTYPE html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <style>
        html, body {    
            margin: 0 !important;
            padding: 0 !important;
            height: 100%;
            font-family: sans-serif;
        }
        .map {
            width: 100%;
            height: 100%;
        }
        .land {
            fill: #ccc;
            fill-opacity: 0.8;
            stroke: #3b3b3b;
        }
        .sea {
            background-color: white;
        }
        .graticule {
            stroke: #185c96;
            stroke-width: 0.3px;
        }
        .panel-container {
            position: absolute;
            top: 0px;
            margin: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid grey;
        }
        .panel-container > svg {
            display: block;
        }
        .panel-container text {
            font-size: 0.7em;
        }
        .co2-colorbar {
            position: absolute;
            bottom: 0px;
            right: 0px;
            margin: 10px;
            width: 300px;
            height: 30px;
            font-size: 0.2em;
        }
    </style>
    </head>
<body>
    
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v0.min.js"></script>
    
    <!-- <script src="d3.v3.min.js"></script>
    <script src="d3.geo.projection.v0.min.js"></script>
    <script src="queue.v1.min.js"></script>
    <script src="topojson.v0.min.js"></script> -->

    <script src="scripts/countrymap.js"></script>
    <script src="scripts/colorbar.js"></script>
    <script src="scripts/exchangelayer.js"></script>

    <svg class="co2-colorbar"></svg>
    <svg class="map sea"></svg>
    <svg class="exchange-arrows-layer"></svg>
    <div class="panel-container">
        <svg class="production-panel"></svg>
        <svg class="exchanges-panel"></svg>
    </div>
    <script>
        let panelWidth = 450
            panelPadding = 10;

        let productionBarHeight = 8
            productionBarMarginY = 10
            innerMarginX = 8
            prefixTextMaxWidth = 80
            suffixTextMaxWidth = 130;

        let co2color = d3.scale.linear()
            .domain([0, 250, 500])
            .range(['green', 'orange', 'black']);

        let productionColors = {
            'wind': '#74cdb9',
            'solar': '#f27406',
            'hydro': '#2772b2',
            'biomass': '#166a57',
            'coal': '#ac8c35',
            'oil': '#8356a2',
            'nuclear': '#f5b300',
            'gas': '#f30a0a',
            'other': 'gray'
        };
        let productionModes = d3.keys(productionColors);

        // Set up objects
        let countryMap = new CountryMap('.map');
        let exchangeLayer = new ExchangeLayer('.map', countryMap.projection());

        let productionPanelHeight = productionModes.length * (productionBarHeight + productionBarMarginY)
        let productionBarMaxWidth = panelWidth - 2 * panelPadding - prefixTextMaxWidth - suffixTextMaxWidth - 2 * innerMarginX;
        let panelContainer = d3.select('.panel-container')
            .style('width', panelWidth)
            .style('padding', panelPadding + 'px')
        let productionPanel = d3.select('.production-panel')
            .style('width', panelWidth - 2 * panelPadding)
            .style('height', productionPanelHeight)
        let exchangesPanel = d3.select('.exchanges-panel')
            .style('width', panelWidth - 2 * panelPadding)

        let productionScale = d3.scale.linear()
            .range([0, productionBarMaxWidth]);

        let co2Colorbar = new HorizontalColorbar('.co2-colorbar', co2color)
            .markerColor('black');

        let productionRects = {};
        let capacityRects = {};
        let productionPrefixText = {};
        let productionSuffixText = {};
        productionModes.forEach(function (mode, i) {
            capacityRects[mode] = productionPanel.append('rect')
                .attr('height', productionBarHeight)
                .attr('fill', 'none') // TODO: Replace by css?
                .attr('stroke', productionColors[mode])
                .attr('stroke-width', 1.0)
                .attr('opacity', 0.2)
                .attr('y', i * (productionBarMarginY + productionBarHeight))
                .attr('x', prefixTextMaxWidth)
                .attr('shape-rendering', 'crispEdges');
            productionRects[mode] = productionPanel.append('rect')
                .attr('height', productionBarHeight)
                .attr('fill', productionColors[mode])
                .attr('y', i * (productionBarMarginY + productionBarHeight))
                .attr('x', prefixTextMaxWidth)
                .attr('shape-rendering', 'crispEdges');
            productionPrefixText[mode] = productionPanel.append('text')
                .attr('y', 8 + i * (productionBarMarginY + productionBarHeight)); // TODO: Do it with CSS and the em or rem unit measure
            productionSuffixText[mode] = productionPanel.append('text')
                .attr('x', 2 * innerMarginX + prefixTextMaxWidth + productionBarMaxWidth)
                .attr('y', 8 + i * (productionBarMarginY + productionBarHeight))
        });

        function redraw() {
            countryMap.render();

            let cb = function(err, data, realtime) {

                let topo = topojson.object(data, data.objects.europe).geometries;

                let countries = {};
                countries['BE'] = topo[4];
                countries['CH'] = topo[8];
                countries['DE'] = topo[10];
                countries['DK'] = topo[11];
                countries['ES'] = topo[12];
                countries['FI'] = topo[14];
                countries['FR'] = topo[15];
                countries['UK'] = topo[17];
                countries['IE'] = topo[24];
                countries['IT'] = topo[26];
                countries['LU'] = topo[31];
                countries['NL'] = topo[38];
                countries['NO'] = topo[39];
                countries['PT'] = topo[41];
                countries['SE'] = topo[48];

                // Add empty fields
                for (let countryCode of d3.keys(countries)) {
                    countries[countryCode].meta = {};
                    countries[countryCode].meta.capacity = {}
                }

                countries['DE'].meta.capacity = {
                    solar: 39700,
                    wind: 2700 + 40990,
                    gas: 28540,
                    hydro: 5580,
                    biomass: 8860,
                    nuclear: 10790,
                    coal: 27090 + 21140
                };
                countries['DK'].meta.capacity = {
                    wind: 5070,
                    solar: 790,
                    hydro: 0,
                };
                countries['ES'].meta.capacity = {
                    wind: 23025,
                    solar: 5400
                }
                countries['FR'].meta.capacity = {
                    nuclear: 63130,
                    oil: 6670,
                    coal: 2930,
                    hydro: 10326 + 8204 + 4965,
                    gas: 6121,
                    wind: 10358,
                    solar: 6580
                };
                countries['UK'].meta.capacity = {
                    wind: 13500,
                    nuclear: 9000,
                    hydro: 1550,
                    gas: 38000,
                    solar: 8780
                }

                // Prepare exchanges
                let exchanges = [
                    {
                        countries: ['DE', 'DK'],
                        center: countryMap.projection([9.3, 54.9]), 
                        rotation: 0
                    },
                    {
                        countries: ['SE', 'DK'],
                        center: countryMap.projection([13, 55.7]), 
                        rotation: -100
                    },
                    {
                        countries: ['UK', 'FR'],
                        center: countryMap.projection([0, 50.4]), 
                        rotation: 160
                    },
                    {
                        countries: ['DK', 'NO'],
                        center: countryMap.projection([8.8, 58]), 
                        rotation: -25
                    },
                    {
                        countries: ['IE', 'UK'],
                        center: countryMap.projection([-5.7, 53]), 
                        rotation: 100
                    },
                    {
                        countries: ['NL', 'UK'],
                        center: countryMap.projection([3.3, 52.4]), 
                        rotation: -90
                    },
                    {
                        countries: ['FR', 'ES'],
                        center: countryMap.projection([0.3, 42.9]), 
                        rotation: -160
                    },
                    {
                        countries: ['FR', 'DE'],
                        center: countryMap.projection([5.7, 49.8]), 
                        rotation: 50
                    },
                    {
                        countries: ['FR', 'CH'],
                        center: countryMap.projection([6.5, 46.7]), 
                        rotation: 90
                    },
                    {
                        countries: ['FR', 'IT'],
                        center: countryMap.projection([6.5, 44.5]), 
                        rotation: 70
                    }
                ];

                // Populate with realtime data
                for (let countryCode of d3.keys(realtime.data)) {
                    let obj = realtime.data[countryCode];
                    let country = countries[countryCode]
                    for (let k of d3.keys(obj))
                        country.meta[k] = obj[k];
                    // Add extra data
                    // TODO: Calculate co2 in the browser to take into account exchanges
                    country.meta.maxCapacity = 
                        d3.max(d3.values(country.meta.capacity));
                    country.meta.maxProduction = 
                        d3.max(d3.values(country.meta.production));
                    country.meta.totalProduction = 
                        d3.sum(d3.values(country.meta.production));
                    // Populate exchanges
                    // Very hacky as the last country will always have precedence
                    for (let sourceCountryCode of d3.keys(country.meta.exchange)) {
                        // Find the exchange object
                        let matches = exchanges.filter(function (e) { 
                            return (e.countries[0] == countryCode && e.countries[1] == sourceCountryCode) || (e.countries[1] == countryCode && e.countries[0] == sourceCountryCode)
                        });
                        let amount = country.meta.exchange[sourceCountryCode];
                        if (matches.length) {
                            let match = matches[0];
                            match.netFlow = match.countries[0] == sourceCountryCode ? amount : -amount;
                            match.co2 = match.countries.map(function (key) {
                                return countries[key].meta.co2;
                            });
                        } else {
                            if (sourceCountryCode != 'other')
                                console.warn('Missing exchange configuration between ' + sourceCountryCode + ' and ' + countryCode);
                        }
                    }
                    // Send warnings for missing data
                    if (country.meta.co2 === undefined)
                        console.warn(countryCode + ' is missing co2 footprint');
                    productionModes.forEach(function (mode) {
                        if (mode == 'other') return;
                        if (country.meta.production[mode] === undefined)
                            console.warn(countryCode + ' is missing production of ' + mode);
                        if (country.meta.capacity[mode] === undefined)
                            console.warn(countryCode + ' is missing capacity of ' + mode);
                    });
                    if (country.meta.exchange === undefined || country.meta.exchange.length == 0)
                        console.warn(countryCode + ' is missing exchanges');
                }
                console.log('countries', countries);
                console.log('exchanges', exchanges);

                countryMap
                    .data(d3.values(countries))
                    .onCountryClick(function (d, i) {
                        if (!d.meta.production) return;
                        // Production
                        productionScale.domain([0, d.meta.maxCapacity || d.meta.maxProduction]);
                        productionModes.forEach(function (mode) {
                            productionRects[mode]
                                .datum(d.meta)
                                .transition()
                                .attr('width', function (d, i) {
                                    return productionScale(d.production[mode] || 0)
                                });
                            capacityRects[mode]
                                .datum(d.meta)
                                .transition()
                                .attr('width', function (d, i) {
                                    return d.production[mode] === undefined ? 0 : productionScale(d.capacity[mode] || 0)
                                });
                            let production = Math.round(d.meta.production[mode] / 10) * 10
                            if (d.meta.capacity[mode] !== undefined && d.meta.production[mode] !== undefined) {
                                let capacityPct = Math.round(d.meta.production[mode] / d.meta.capacity[mode] * 100) || 0
                                productionSuffixText[mode]
                                    .text(production + ' MW (' + capacityPct + '% capacity)')
                            } else if (d.meta.production[mode] !== undefined) {
                                productionSuffixText[mode].text(production + ' MW');
                            } else {
                                productionSuffixText[mode].text('')
                            }
                            if (d.meta.production[mode] !== undefined) {
                                productionPrefixText[mode]
                                    .text(mode)
                            } else {
                                productionPrefixText[mode].text(mode)
                            }
                        });

                        // Exchanges
                        panelExchangeData = d3.entries(d.meta.exchange)
                            .filter(function (o) {
                                return o.key != 'other';
                            });

                        let exchangesPanelHeight = panelExchangeData.length * (productionBarHeight + productionBarMarginY);
                        let panelHeight = 2 * panelPadding + productionPanelHeight + exchangesPanelHeight;
                        panelContainer
                            .transition()
                            .style('height', panelHeight);
                        exchangesPanel
                            .transition()
                            .style('height', exchangesPanelHeight);

                        let enterG = exchangesPanel.selectAll('.exchange-for-country')
                            .data(panelExchangeData)
                            .enter()
                                .append('g')
                                .attr('class', 'exchange-for-country')
                                .attr('transform', function (d, i) {
                                    return 'translate(0,' + i * (productionBarHeight + productionBarMarginY) + ')';
                                });
                        enterG.append('rect')
                            .attr('x', prefixTextMaxWidth)
                            .attr('height', productionBarHeight)
                            .attr('fill', 'black')
                            .style('transform-origin', 'left')
                        enterG.append('text')
                        exchangesPanel.selectAll('.exchange-for-country')
                            .data(panelExchangeData)
                            .exit().remove()
                        exchangesPanel.selectAll('.exchange-for-country > rect')
                            .data(panelExchangeData)
                            .transition()
                            .attr('width', function (d) { 
                                return productionScale(Math.abs(d.value));
                            })
                            .attr('fill', function (d) {
                                return d.value > 0 ? co2color(countries[d.key].meta.co2) : 'black';
                            })
                            .style('transform', function (d) {
                                return d.value < 0 ? 'scaleX(-1)' : ''; 
                            });
                        exchangesPanel.selectAll('.exchange-for-country > text')
                            .data(panelExchangeData)
                            .text(function(d) { return d.key; });
                    })
                    .onCountryMouseOver(function (d) { 
                        if (d.meta.production)
                            d3.select(this)
                                .attr('opacity', 0.8)
                                .style('cursor', 'hand')
                        if (d.meta.co2)
                            co2Colorbar.currentMarker(d.meta.co2);
                    })
                    .onCountryMouseOut(function (d) { 
                        if (d.meta.production) 
                            d3.select(this)
                                .attr('opacity', 1)
                                .style('cursor', 'normal')
                        if (d.meta.co2)
                            co2Colorbar.currentMarker(undefined);
                    });

                exchangeLayer.data(exchanges);
            };

            queue()
                .defer(d3.json, 'http://localhost:8000/data/europe.topo.json')
                .defer(d3.json, 'http://localhost:8000/realtime')
                .await(cb);
        };

        // TODO: Put as much as possible in CSS

        window.onresize = function () {
            redraw();
        };

        redraw();
    </script>   
</body>
</html>
